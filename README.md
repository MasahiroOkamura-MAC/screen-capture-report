# 画面キャプチャ＆レポートアプリ - ウォークスルー

## 概要
これは、1分ごとに画面をキャプチャし、Geminiを使用してアクティビティを分析し、Nanobananaで生成された図解付きの日報をメールで送信するmacOSメニューバーアプリケーションです。

## 前提条件
- macOS
- Python 3.x
- Gemini APIキー
- メール送信用のGmail（またはその他のSMTP）アカウント

## セットアップ

1. **依存関係のインストール**
   依存関係は自動的にインストールされているはずです。もしインストールされていない場合は、以下を実行してください：
   ```bash
   source venv/bin/activate
   pip install -r requirements.txt
   ```

2. **設定**
   プロジェクトディレクトリ内の `.env.example` をコピーして `.env` を作成し、詳細を入力してください：
   ```bash
   cp .env.example .env
   ```
   
   `.env` ファイルを開き、以下の項目を設定します：
   - `GEMINI_API_KEY`: Google AI Studioから取得してください。
   - `SMTP_...`: メール設定（Gmailの場合はアプリパスワードを使用してください）。
   - `EMAIL_FROM`: 送信元のメールアドレス。
   - `EMAIL_TO`: レポートの送信先メールアドレス。
   - `CAPTURE_MODE`: `active_window` に設定すると、最前面のウィンドウのみをキャプチャします（デフォルトは `all_screens`）。

   > [!IMPORTANT]
   > **アクティブウィンドウキャプチャの権限について**:
   > `CAPTURE_MODE=active_window` を使用する場合、macOSの「アクセシビリティ」権限が必要です。
   > 1. `システム設定 > プライバシーとセキュリティ > アクセシビリティ` を開きます。
   > 2. 使用しているターミナル（VS Code, iTermなど）またはPythonのスイッチを **ON** にしてください。
   > 3. 設定変更後はターミナルを再起動してください。

   > [!TIP]
   > **Gmailアプリパスワードの取得方法**:
   > 1. [Googleアカウント管理](https://myaccount.google.com/) にアクセスします。
   > 2. 左側のメニューから「セキュリティ」を選択します。
   > 3. 「Google へのログイン」セクションで「2段階認証プロセス」がオンになっていることを確認します（オフの場合はオンにしてください）。
   > 4. 検索バー（上部）で「アプリ パスワード」と検索して選択します。
   > 5. アプリ名に適当な名前（例: "ScreenCaptureApp"）を入力して「作成」をクリックします。
   > 6. 生成された16桁のパスワードをコピーし、`.env` ファイルの `SMTP_PASSWORD` に貼り付けます（スペースは削除不要ですが、詰めて入力しても構いません）。

## Macアプリとして利用する（推奨）

ターミナルを使わずに、デスクトップアプリとして簡単に利用できます。

1. **アプリの場所**
   プロジェクトフォルダ内の `ScreenCaptureReport.app` が本体です。

2. **デスクトップへの追加**
   `ScreenCaptureReport.app` を、**Command (⌘) + Option (⌥)** キーを押しながらデスクトップにドラッグ＆ドロップすると、エイリアス（ショートカット）を作成できます。

3. **初回起動と設定（オンボーディング）**
   アプリをダブルクリックすると、初回のみ設定ウィザードが表示されます。
   - **Gemini API Key**: 必須入力です。
   - **Email** (任意): レポート送信用のGmailアドレス設定などを行えます。
   - **Gmail App Password** (任意): Gmail送信には[アプリパスワード](https://support.google.com/mail/answer/185833?hl=ja)が必要です（通常のログインパスワードではありません）。
   - 入力内容は自動的に `.env` ファイルに保存されます。

4. **重要な権限設定（必ず行ってください）**
   `.app` 経由で実行する場合、macOSのセキュリティ設定で個別に権限を許可する必要があります。
   
   - **画面収録 (Screen Recording)**: 画面のピクセルを取得するために必要です。
   - **アクセシビリティ (Accessibility)**: アクティブなウィンドウの境界線（サイズや位置）を取得するために必要です。

   **設定手順**:
   1. `システム設定 > プライバシーとセキュリティ > 画面収録` を開き、**ScreenCaptureReport.app** を追加して **ON** にします。
   2. `システム設定 > プライバシーとセキュリティ > アクセシビリティ` を開き、**ScreenCaptureReport.app** を追加して **ON** にします。
   3. 設定変更後は、アプリを一度終了（Quit App）して、**開き直してください**。


5. **アプリの管理 / 設定リセット**
   アプリはバックグラウンドで常駐します（Dockにインジケータがつきます）。
   **起動中のアプリアイコンをもう一度クリック（またはダブルクリック）** すると、以下の管理メニューが表示されます。
   - **Reset Settings**: 設定ファイル（`.env`）を削除してアプリを終了します。次回起動時に再設定できます。
   - **Quit App**: アプリを完全に終了します。
   - **Hide**: ダイアログを閉じて、そのままバックグラウンドで動作を続けます。

## コマンドラインでの利用（開発者向け）
アプリとしてではなく、ターミナルから直接スクリプトを実行する場合の手順です。

1. **アプリの実行**
   ```bash
   source venv/bin/activate
   python -m src.main
   ```
   メニューバーに「SCApp」アイコン（またはPythonアイコン）が表示されます。
   **起動と同時に自動的にキャプチャが開始されます。**

2. **使い方**
   - **自動機能**:
     - **キャプチャ**: 1分ごとに画面をキャプチャします。
       - `CAPTURE_MODE=active_window` の場合、基本はアクティブウィンドウのみですが、**5回に1回は全画面**をキャプチャしてコンテキストを記録します。
     - **分析**: 5分ごとに、画像をGeminiに送信して分析します。ログは**1時間単位**で管理され、過去のログは保持されつつ、直近1時間のログのみが更新されます。
     - **レポート送信**: 毎日 **18:00** に自動的にレポートをメールで送信します。
     - **未送信レポートの自動処理**: アプリ起動時に、過去の日付や当日の18:00以降の未送信レポートがある場合、自動的に送信処理が行われます。
   
   - **メニュー操作**:
     - **Start/Stop Capture**: キャプチャの一時停止・再開。
     - **Capture Now**: 即座に画面をキャプチャします。
     - **Analyze Now**: 現在溜まっている画像を即座に分析します。
     - **Generate Report Now**: 現在のログ内容で即座にレポートを生成・送信します。
     - **Open Data Folder**: 画像とログが保存されているフォルダを開きます。

   - **データの確認方法**:
     - 画像は `data/captures` フォルダに保存されます。
     - 分析ログは `data/daily_log.txt` に追記されます。

## トラブルシューティング
- **権限拒否 (Permission Denied)**: macOSでは、ターミナルまたはPythonアプリに「画面収録」の権限が必要です。`システム設定 > プライバシーとセキュリティ > 画面収録` に移動し、使用しているターミナル（iTerm、Terminalなど）またはPythonを許可してください。
- **メール送信失敗**: Gmailを使用している場合、ログインパスワードではなく「アプリパスワード」を使用していることを確認してください。
- **ModuleNotFoundError: No module named 'src'**:
  起動コマンドが間違っている可能性があります。`python src/main.py` ではなく、必ず **`python -m src.main`** を使用してください。
- **メニューが表示されない / 反応しない**:
  - **ノッチ**: 最新のMacBookでは、ノッチ（画面上部のカメラ部分）の裏にアイコンが隠れてしまっている可能性があります。他のメニューバーアプリを終了してスペースを空けてみてください。
  - **フォーカス**: アプリ起動直後は、一度デスクトップのどこかをクリックしてから、再度メニューバーアイコンをクリックしてみてください。
  - **権限**: ターミナルまたは **ScreenCaptureReport.app** に「アクセシビリティ」や「画面収録」の権限が正しく付与されているか確認してください。
- **画像にウィンドウが写っていない（壁紙のみ）**:
  これは「画面収録」の権限が不足している典型的な症状です。
  1. `システム設定 > プライバシーとセキュリティ > 画面収録` を開きます。
  2. リストに現在使用しているターミナル（VS Code, iTerm, Terminalなど）や `Python` があるか確認し、スイッチを **ON** にします。
  3. **リストにない場合**: リストの下にある「＋」ボタンをクリックし、`アプリケーション > ユーティリティ > ターミナル`（または使用中のアプリ）を手動で追加してください。
  4. 設定変更後は、必ずアプリ（ターミナル）を**再起動**してください。
